<script>
const _zigDataUrl = 'https://zignaly.directus.app';

// Function to get the value of a query parameter by name
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// Function to fetch data from the API
async function fetchData(url) {
    try {
        const response = await fetch(url);
        if (response.status === 200) {
            const data = await response.json();
            return data.data;
        }
    } catch (error) {
        console.error('API call failed:', error);
    }
    return null;
}

// Function to validate referrer code with API
async function validateRefCode(refCode) {
    const url = `${_zigDataUrl}/items/zigchain_leads?filter[slug][_eq]=${refCode}&limit=1`;
    const data = await fetchData(url);
    if (data && data.length === 1) {
        return data[0];
    }
    return null;
}

// Function to handle referral check and storage
async function handleReferral() {
    const zParam = getQueryParam('z');
    const storedRefCode = localStorage.getItem('ref_code_by');
    const storedRefBy = localStorage.getItem('ref_by');

    if (zParam && zParam !== storedRefCode) {
        const validRef = await validateRefCode(zParam);
        if (validRef) {
            localStorage.setItem('ref_by', validRef.id);
            localStorage.setItem('ref_code_by', validRef.ref_code);
            document.querySelector('input[name="ref_by"]').value = validRef.id;
        } else {
            // If zParam is not a valid code, assume it is an ID
            localStorage.setItem('ref_by', zParam);
            document.querySelector('input[name="ref_by"]').value = zParam;
        }
    } else if (storedRefBy) {
        document.querySelector('input[name="ref_by"]').value = storedRefBy;
    }
}

// Function to fetch user data by email
async function fetchUserByEmail(email) {
    const url = `${_zigDataUrl}/items/zigchain_leads?filter[email][_eq]=${email}`;
    return await fetchData(url);
}

// Function to handle user ID check and storage
async function handleUserId() {
    const yourRefID = localStorage.getItem('your_ref_id');
    const yourRefCode = localStorage.getItem('your_ref_code');
    const email = localStorage.getItem('email');

    if (!yourRefCode && !yourRefID && email) {
        // TO DO: Create a webhook instead of fetching the user data by email for security reasons.
        const user = await fetchUserByEmail(email);
        if (user && user.length === 1) {
            localStorage.setItem('your_ref_id', user[0].id);
            if (user[0].ref_code) {
                localStorage.setItem('your_ref_code', user[0].ref_code);
            }
            localStorage.removeItem('email');
        }
    }
}

// Execute the referral handler and user ID handler on page load
window.addEventListener('load', async () => {
    await handleReferral();
    await handleUserId();
});
</script>